{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Student Union Voting System{% endblock %}

{% block content %}
<style>
    :root {
        --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        --card-shadow-hover: 0 8px 32px rgba(0, 0, 0, 0.12);
        --gradient-primary: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        --border-radius-sm: 8px;
        --border-radius-md: 12px;
        --border-radius-lg: 16px;
        --border-radius-xl: 20px;
        --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --backdrop-blur: blur(20px);
    }

    /* Dashboard Grid System */
    .dashboard-grid {
        display: grid;
        gap: 2rem;
        grid-template-columns: 1fr;
    }

    @media (min-width: 1200px) {
        .dashboard-grid {
            grid-template-columns: 2fr 1fr;
        }
    }

    /* Enhanced Welcome Section */
    .welcome-hero {
        background: var(--gradient-primary);
        border-radius: var(--border-radius-xl);
        padding: 2.5rem;
        margin-bottom: 2.5rem;
        position: relative;
        overflow: hidden;
        box-shadow: var(--card-shadow);
    }

    .welcome-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmZmZmYiIGZpbGwtb3BhY2l0eT0iMC4wNSI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNCIvPjwvZz48L2c+PC9zdmc+');
        animation: float-pattern 20s linear infinite;
        pointer-events: none;
    }

    @keyframes float-pattern {
        0% { transform: translateX(-60px) translateY(-60px); }
        100% { transform: translateX(0) translateY(0); }
    }

    .welcome-content {
        position: relative;
        z-index: 2;
        color: white;
        text-align: center;
    }

    .welcome-title {
        font-size: 2.25rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
        letter-spacing: -0.025em;
    }

    .welcome-subtitle {
        font-size: 1.125rem;
        opacity: 0.9;
        margin-bottom: 2rem;
        font-weight: 400;
    }

    .student-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .metric-card {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: var(--backdrop-blur);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: var(--border-radius-md);
        padding: 1.5rem;
        text-align: center;
        transition: var(--transition-smooth);
    }

    .metric-card:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.2);
    }

    .metric-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
        opacity: 0.8;
        margin-bottom: 0.5rem;
    }

    .metric-value {
        font-size: 1rem;
        font-weight: 600;
        color: white;
    }

    /* Enhanced Card System */
    .professional-card {
        background: white;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--card-shadow);
        border: 1px solid #e5e7eb;
        transition: var(--transition-smooth);
        overflow: hidden;
    }

    .professional-card:hover {
        box-shadow: var(--card-shadow-hover);
        transform: translateY(-1px);
    }

    .card-header-custom {
        background: #f8fafc;
        border-bottom: 1px solid #e5e7eb;
        padding: 1.5rem;
        position: relative;
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 0;
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--dark-color);
        margin: 0;
    }

    .section-icon {
        width: 40px;
        height: 40px;
        background: var(--gradient-primary);
        border-radius: var(--border-radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.125rem;
    }

    /* Enhanced Status System */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 600;
        letter-spacing: 0.025em;
        text-transform: uppercase;
    }

    .status-active {
        background: linear-gradient(135deg, #10b981, #34d399);
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .status-pending {
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
        color: white;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .status-completed {
        background: linear-gradient(135deg, #059669, #10b981);
        color: white;
        box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
    }

    .status-inactive {
        background: #f1f5f9;
        color: #64748b;
        border: 1px solid #e2e8f0;
    }

    /* Progress Tracking */
    .progress-overview {
        padding: 1.5rem;
    }

    .progress-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 0;
        border-bottom: 1px solid #f1f5f9;
        transition: var(--transition-smooth);
    }

    .progress-item:hover {
        background: #f8fafc;
        margin: 0 -1.5rem;
        padding-left: 1.5rem;
        padding-right: 1.5rem;
    }

    .progress-item:last-child {
        border-bottom: none;
    }

    .progress-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
    }

    .progress-icon {
        width: 36px;
        height: 36px;
        border-radius: var(--border-radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }

    .progress-icon.completed {
        background: #dcfdf7;
        color: #059669;
    }

    .progress-icon.pending {
        background: #fef3c7;
        color: #d97706;
    }

    .progress-icon.inactive {
        background: #f1f5f9;
        color: #64748b;
    }

    .progress-label {
        font-weight: 600;
        color: var(--dark-color);
    }

    .progress-description {
        font-size: 0.875rem;
        color: #64748b;
    }

    /* Enhanced Voting Cards */
    .voting-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        padding: 1.5rem;
    }

    .voting-card {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: var(--border-radius-lg);
        padding: 1.5rem;
        transition: var(--transition-smooth);
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .voting-card:hover {
        border-color: var(--primary-color);
        box-shadow: var(--card-shadow-hover);
        transform: translateY(-2px);
    }

    .voting-card.selected {
        border-color: var(--success-color);
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(52, 211, 153, 0.02));
        box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.2);
    }

    .voting-card.voted {
        border-color: var(--success-color);
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(52, 211, 153, 0.04));
        position: relative;
    }

    .voting-card.voted::after {
        content: 'âœ“';
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 24px;
        height: 24px;
        background: var(--success-color);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        font-weight: bold;
    }

    .candidate-profile {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .candidate-avatar {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: var(--gradient-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: 700;
        flex-shrink: 0;
        position: relative;
        overflow: hidden;
    }

    .candidate-avatar::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transform: rotate(45deg);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .candidate-info {
        flex: 1;
    }

    .candidate-name {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: 0.25rem;
    }

    .candidate-details {
        font-size: 0.875rem;
        color: #64748b;
        margin-bottom: 0.75rem;
    }

    .party-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.875rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Enhanced Buttons */
    .vote-button {
        width: 100%;
        padding: 0.875rem 1.5rem;
        border-radius: var(--border-radius-md);
        border: none;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition: var(--transition-smooth);
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }

    .vote-button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .vote-button.btn-vote {
        background: var(--gradient-primary);
        color: white;
        box-shadow: 0 4px 12px rgba(30, 58, 138, 0.3);
    }

    .vote-button.btn-vote:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(30, 58, 138, 0.4);
    }

    .vote-button.btn-voted {
        background: var(--gradient-success);
        color: white;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    /* Manifesto Modal Enhancement */
    .manifesto-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--primary-color);
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        padding: 0.5rem 0;
        transition: var(--transition-smooth);
        border-bottom: 1px solid transparent;
    }

    .manifesto-toggle:hover {
        color: var(--secondary-color);
        border-bottom-color: var(--secondary-color);
    }

    .manifesto-preview {
        margin-top: 1rem;
        padding: 1rem;
        background: #f8fafc;
        border-left: 4px solid var(--primary-color);
        border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
        font-size: 0.875rem;
        line-height: 1.6;
        color: #475569;
        display: none;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Alert Enhancements */
    .alert-enhanced {
        border: none;
        border-radius: var(--border-radius-md);
        padding: 1.25rem 1.5rem;
        margin-bottom: 1.5rem;
        font-weight: 500;
        box-shadow: var(--card-shadow);
    }

    .alert-success-enhanced {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.05));
        border-left: 4px solid var(--success-color);
        color: #065f46;
    }

    .alert-info-enhanced {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 197, 253, 0.05));
        border-left: 4px solid var(--secondary-color);
        color: #1e3a8a;
    }

    .alert-warning-enhanced {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.05));
        border-left: 4px solid var(--warning-color);
        color: #92400e;
    }

    /* Loading States */
    .loading-spinner {
        display: none;
        animation: spin 1s linear infinite;
    }

    .vote-button.loading .btn-text {
        opacity: 0;
    }

    .vote-button.loading .loading-spinner {
        display: inline-block;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #64748b;
    }

    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        opacity: 0.5;
    }

    .empty-state-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--dark-color);
    }

    .empty-state-description {
        font-size: 1rem;
        max-width: 400px;
        margin: 0 auto;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .welcome-title {
            font-size: 1.875rem;
        }
        
        .student-metrics {
            grid-template-columns: 1fr;
        }
        
        .voting-grid {
            grid-template-columns: 1fr;
            padding: 1rem;
        }
        
        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .candidate-profile {
            flex-direction: column;
            text-align: center;
        }
    }

    /* Accessibility Enhancements */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    /* Focus states */
    .voting-card:focus-visible,
    .vote-button:focus-visible,
    .manifesto-toggle:focus-visible {
        outline: 2px solid var(--accent-color);
        outline-offset: 2px;
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
        .voting-card {
            border-width: 3px;
        }
        
        .vote-button {
            border: 2px solid currentColor;
        }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }
</style>

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">


<!-- Enhanced Welcome Section -->
<section class="welcome-hero" role="banner">
    <div class="welcome-content">
        <h1 class="welcome-title">
            Welcome back, {{ student.first_name }}
        </h1>
        <p class="welcome-subtitle">
            Your participation shapes the future of our student union
        </p>
        
        <div class="student-metrics">
            <div class="metric-card">
                <div class="metric-label">Registration</div>
                <div class="metric-value">{{ student.registration_number }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Department</div>
                <div class="metric-value">
                    {% if student.programme.department %}
                        {{ student.programme.department.name }}
                    {% else %}
                        Not Assigned
                    {% endif %}
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Faculty</div>
                <div class="metric-value">
                    {% if student.programme.department.faculty %}
                        {{ student.programme.department.faculty.name }}
                    {% else %}
                        Not Assigned
                    {% endif %}
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Year of Study</div>
                <div class="metric-value">
                    {{ student.get_year_of_study_display|default:"Not Set" }}
                </div>
            </div>
        </div>
    </div>
</section>

{% if election %}
<div class="dashboard-grid">
    <!-- Main Voting Content -->
    <div class="main-content">
        <!-- Election Status Card -->
        <article class="professional-card mb-4" role="article">
            <header class="card-header-custom">
                <div class="section-header">
                    <h2 class="section-title">
                        <div class="section-icon">
                            <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                        </div>
                        {{ election.name }}
                    </h2>
                    <div class="status-badge {% if election.current_phase == 'delegate_voting' %}status-active{% elif election.current_phase == 'main_voting' %}status-active{% elif election.current_phase == 'results' %}status-completed{% else %}status-pending{% endif %}">
                        <i class="fas fa-circle" aria-hidden="true"></i>
                        {{ election.get_current_phase_display }}
                    </div>
                </div>
            </header>
            <div class="card-body p-4">
                <p class="mb-0 text-muted">{{ election.description }}</p>
                
                {% if election.current_phase == 'delegate_voting' %}
                <div class="alert alert-info-enhanced mt-3" role="alert">
                    <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                    <strong>Delegate Voting Phase:</strong> Choose your department representative.
                    <div class="small mt-1">
                        Ends: {{ election.delegate_voting_end|date:"M d, Y \a\t H:i" }}
                    </div>
                </div>
                {% elif election.current_phase == 'main_voting' %}
                <div class="alert alert-info-enhanced mt-3" role="alert">
                    <i class="fas fa-vote-yea me-2" aria-hidden="true"></i>
                    <strong>Main Voting Phase:</strong> Delegates vote for executive positions.
                    <div class="small mt-1">
                        Ends: {{ election.main_voting_end|date:"M d, Y \a\t H:i" }}
                    </div>
                </div>
                {% elif election.current_phase == 'results' %}
                <div class="alert alert-success-enhanced mt-3" role="alert">
                    <i class="fas fa-trophy me-2" aria-hidden="true"></i>
                    <strong>Election Complete:</strong> Results are now available.
                    <a href="{% url 'results' %}" class="btn btn-success ms-3">
                        <i class="fas fa-chart-bar me-1" aria-hidden="true"></i>
                        View Results
                    </a>
                </div>
                {% endif %}
            </div>
        </article>

        <!-- Delegate Voting Section -->
        {% if election.current_phase == 'delegate_voting' or has_voted_for_delegate %}
        <article class="professional-card mb-4" role="article">
            <header class="card-header-custom">
                <h3 class="section-title">
                    <div class="section-icon">
                        <i class="fas fa-users" aria-hidden="true"></i>
                    </div>
                    Department Delegate Voting
                </h3>
            </header>
            
            {% if has_voted_for_delegate %}
            <div class="card-body p-4">
                <div class="alert alert-success-enhanced" role="alert">
                    <i class="fas fa-check-circle me-2" aria-hidden="true"></i>
                    <strong>Vote Successfully Recorded!</strong>
                    <div class="mt-2">
                        You voted for <strong>{{ delegate_vote.delegate.student.full_name }}</strong> 
                        representing <strong>{{ delegate_vote.delegate.party.name }}</strong>.
                    </div>
                </div>
            </div>
            {% elif election.is_delegate_voting_active %}
            <div class="voting-grid">
                {% for delegate in available_delegates %}
                <div class="voting-card" 
                     data-delegate-id="{{ delegate.id }}" 
                     tabindex="0"
                     role="button"
                     aria-label="Vote for {{ delegate.student.full_name }} from {{ delegate.party.acronym }}">
                    
                    <div class="candidate-profile">
                        <div class="candidate-avatar" 
                             style="background: linear-gradient(135deg, {{ delegate.party.color_code }}, {{ delegate.party.color_code }}CC);">
                            {{ delegate.student.first_name.0 }}{{ delegate.student.last_name.0 }}
                        </div>
                        <div class="candidate-info">
                            <h4 class="candidate-name">{{ delegate.student.full_name }}</h4>
                            <div class="candidate-details">
                                <div>{{ delegate.student.registration_number }}</div>
                                <div>{{ delegate.department.name }} Department</div>
                            </div>
                            <div class="party-badge" 
                                 style="background-color: {{ delegate.party.color_code }}20; color: {{ delegate.party.color_code }};">
                                <i class="fas fa-flag" aria-hidden="true"></i>
                                {{ delegate.party.acronym }}
                            </div>
                        </div>
                    </div>
                    
                    <button class="vote-button btn-vote" 
                            onclick="voteForDelegate({{ delegate.id }})"
                            aria-label="Cast vote for {{ delegate.student.full_name }}">
                        <span class="btn-text">
                            <i class="fas fa-vote-yea me-2" aria-hidden="true"></i>
                            Vote for {{ delegate.student.first_name }}
                        </span>
                        <span class="loading-spinner fas fa-spinner" aria-hidden="true"></span>
                    </button>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-users-slash" aria-hidden="true"></i>
                        </div>
                        <h3 class="empty-state-title">No Delegates Available</h3>
                        <p class="empty-state-description">
                            There are currently no approved delegates in your department. 
                            Please contact the election committee for more information.
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="card-body p-4">
                <div class="alert alert-warning-enhanced" role="alert">
                    <i class="fas fa-clock me-2" aria-hidden="true"></i>
                    <strong>Delegate voting is not currently active.</strong>
                    <div class="mt-2">
                        Voting period: {{ election.delegate_voting_start|date:"M d, Y H:i" }} - 
                        {{ election.delegate_voting_end|date:"M d, Y H:i" }}
                    </div>
                </div>
            </div>
            {% endif %}
        </article>
        {% endif %}

        <!-- Main Voting Section (For Delegates) -->
        {% if is_delegate and election.current_phase == 'main_voting' %}
        <article class="professional-card mb-4" role="article">
            <header class="card-header-custom">
                <h3 class="section-title">
                    <div class="section-icon">
                        <i class="fas fa-award" aria-hidden="true"></i>
                    </div>
                    Executive Position Voting
                </h3>
            </header>
            
            <div class="card-body p-4">
                <div class="alert alert-info-enhanced mb-4" role="alert">
                    <i class="fas fa-user-tie me-2" aria-hidden="true"></i>
                    <strong>You are an authorized delegate!</strong>
                    <div class="mt-1">
                        Representing <strong>{{ delegate_profile.department.name }}</strong> department in the executive elections.
                    </div>
                </div>
                
                {% for position in positions %}
                <section class="position-section mb-4" aria-labelledby="position-{{ position.id }}">
                    <header class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                        <h4 id="position-{{ position.id }}" class="position-name">
                            {{ position.get_name_display }}
                        </h4>
                        <div class="status-badge {% if position.id in voted_positions %}status-completed{% else %}status-pending{% endif %}">
                            {% if position.id in voted_positions %}
                                <i class="fas fa-check" aria-hidden="true"></i>
                                Voted
                            {% else %}
                                <i class="fas fa-clock" aria-hidden="true"></i>
                                Pending
                            {% endif %}
                        </div>
                    </header>
                    
                    {% if position.id in voted_positions %}
                        {% for vote in delegate_votes %}
                            {% if vote.candidate.position.id == position.id %}
                            <div class="alert alert-success-enhanced" role="alert">
                                <i class="fas fa-check-circle me-2" aria-hidden="true"></i>
                                <strong>Vote Recorded:</strong> {{ vote.candidate.student.full_name }}
                                <div class="small mt-1">
                                    {{ vote.candidate.party.name }} ({{ vote.candidate.party.acronym }})
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="voting-grid">
                            {% for candidate in candidates %}
                                {% if candidate.position.id == position.id %}
                                <div class="voting-card" 
                                     data-candidate-id="{{ candidate.id }}"
                                     tabindex="0"
                                     role="button"
                                     aria-label="Vote for {{ candidate.student.full_name }} for {{ position.get_name_display }}">
                                    
                                    <div class="candidate-profile">
                                        <div class="candidate-avatar"
                                             style="background: linear-gradient(135deg, {{ candidate.party.color_code }}, {{ candidate.party.color_code }}CC);">
                                            {{ candidate.student.first_name.0 }}{{ candidate.student.last_name.0 }}
                                        </div>
                                        <div class="candidate-info">
                                            <h5 class="candidate-name">{{ candidate.student.full_name }}</h5>
                                            <div class="candidate-details">
                                                <div>{{ candidate.student.registration_number }}</div>
                                                <div>{{ candidate.student.programme.department.name }}</div>
                                            </div>
                                            <div class="party-badge" 
                                                 style="background-color: {{ candidate.party.color_code }}20; color: {{ candidate.party.color_code }};">
                                                <i class="fas fa-flag" aria-hidden="true"></i>
                                                {{ candidate.party.acronym }}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {% if candidate.manifesto %}
                                    <div class="mt-3">
                                        <a href="#" class="manifesto-toggle" 
                                           onclick="toggleManifesto({{ candidate.id }}); return false;"
                                           aria-expanded="false"
                                           aria-controls="manifesto-{{ candidate.id }}">
                                            <i class="fas fa-file-alt me-1" aria-hidden="true"></i>
                                            View Manifesto
                                        </a>
                                        <div class="manifesto-preview" 
                                             id="manifesto-{{ candidate.id }}"
                                             role="region"
                                             aria-label="Manifesto for {{ candidate.student.full_name }}">
                                            <strong>Manifesto:</strong>
                                            <p class="mt-2 mb-0">{{ candidate.manifesto|truncatewords:50 }}</p>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mt-3">
                                        <button class="vote-button btn-vote" 
                                                onclick="voteForCandidate({{ candidate.id }}, '{{ position.get_name_display }}')"
                                                aria-label="Cast vote for {{ candidate.student.full_name }} for {{ position.get_name_display }}">
                                            <span class="btn-text">
                                                <i class="fas fa-vote-yea me-2" aria-hidden="true"></i>
                                                Vote for {{ candidate.student.first_name }}
                                            </span>
                                            <span class="loading-spinner fas fa-spinner" aria-hidden="true"></span>
                                        </button>
                                    </div>
                                </div>
                                {% endif %}
                            {% empty %}
                                <div class="col-12">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">
                                            <i class="fas fa-user-slash" aria-hidden="true"></i>
                                        </div>
                                        <h4 class="empty-state-title">No Candidates</h4>
                                        <p class="empty-state-description">
                                            No candidates are available for this position.
                                        </p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </section>
                {% endfor %}
            </div>
        </article>
        {% endif %}

        <!-- Results Section -->
        {% if election.current_phase == 'results' %}
        <article class="professional-card mb-4" role="article">
            <header class="card-header-custom">
                <h3 class="section-title">
                    <div class="section-icon">
                        <i class="fas fa-chart-bar" aria-hidden="true"></i>
                    </div>
                    Election Results
                </h3>
            </header>
            <div class="card-body p-4">
                <div class="alert alert-success-enhanced" role="alert">
                    <i class="fas fa-trophy me-2" aria-hidden="true"></i>
                    <strong>Election Successfully Completed!</strong>
                    <div class="mt-3">
                        <a href="{% url 'results' %}" class="btn btn-success">
                            <i class="fas fa-chart-line me-2" aria-hidden="true"></i>
                            View Detailed Results
                        </a>
                        <a href="{% url 'results_summary' %}" class="btn btn-outline-success ms-2">
                            <i class="fas fa-file-pdf me-2" aria-hidden="true"></i>
                            Download Summary
                        </a>
                    </div>
                </div>
            </div>
        </article>
        {% endif %}
    </div>

    <!-- Sidebar with Progress and Information -->
    <aside class="sidebar-content" role="complementary">
        <!-- Voting Progress Card -->
        <article class="professional-card mb-4">
            <header class="card-header-custom">
                <h3 class="section-title">
                    <div class="section-icon">
                        <i class="fas fa-tasks" aria-hidden="true"></i>
                    </div>
                    Your Progress
                </h3>
            </header>
            <div class="progress-overview">
                <div class="progress-item">
                    <div class="progress-info">
                        <div class="progress-icon {% if has_voted_for_delegate %}completed{% elif election.is_delegate_voting_active %}pending{% else %}inactive{% endif %}">
                            <i class="fas fa-users" aria-hidden="true"></i>
                        </div>
                        <div>
                            <div class="progress-label">Department Delegate</div>
                            <div class="progress-description">
                                {% if has_voted_for_delegate %}
                                    Vote successfully recorded
                                {% elif election.is_delegate_voting_active %}
                                    Vote now to select your representative
                                {% else %}
                                    Voting not yet available
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="status-badge {% if has_voted_for_delegate %}status-completed{% elif election.is_delegate_voting_active %}status-pending{% else %}status-inactive{% endif %}">
                        {% if has_voted_for_delegate %}
                            <i class="fas fa-check" aria-hidden="true"></i>
                            Done
                        {% elif election.is_delegate_voting_active %}
                            <i class="fas fa-clock" aria-hidden="true"></i>
                            Active
                        {% else %}
                            <i class="fas fa-pause" aria-hidden="true"></i>
                            Waiting
                        {% endif %}
                    </div>
                </div>

                {% if is_delegate %}
                <div class="progress-item">
                    <div class="progress-info">
                        <div class="progress-icon {% if delegate_votes|length == positions|length %}completed{% elif election.is_main_voting_active %}pending{% else %}inactive{% endif %}">
                            <i class="fas fa-award" aria-hidden="true"></i>
                        </div>
                        <div>
                            <div class="progress-label">Executive Voting</div>
                            <div class="progress-description">
                                {% if election.is_main_voting_active %}
                                    {{ delegate_votes|length }}/{{ positions|length }} positions voted
                                {% elif election.current_phase == 'results' %}
                                    Voting completed - view results
                                {% else %}
                                    Waiting for voting phase
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="status-badge {% if delegate_votes|length == positions|length %}status-completed{% elif election.is_main_voting_active %}status-pending{% else %}status-inactive{% endif %}">
                        {% if delegate_votes|length == positions|length %}
                            <i class="fas fa-check" aria-hidden="true"></i>
                            Complete
                        {% elif election.is_main_voting_active %}
                            <i class="fas fa-vote-yea" aria-hidden="true"></i>
                            {{ delegate_votes|length }}/{{ positions|length }}
                        {% else %}
                            <i class="fas fa-pause" aria-hidden="true"></i>
                            Waiting
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </article>

        <!-- Election Timeline Card -->
        <article class="professional-card mb-4">
            <header class="card-header-custom">
                <h3 class="section-title">
                    <div class="section-icon">
                        <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                    </div>
                    Election Timeline
                </h3>
            </header>
            <div class="progress-overview">
                <div class="progress-item">
                    <div class="progress-info">
                        <div class="progress-icon completed">
                            <i class="fas fa-clipboard-list" aria-hidden="true"></i>
                        </div>
                        <div>
                            <div class="progress-label">Registration Phase</div>
                            <div class="progress-description">Candidate & delegate registration</div>
                        </div>
                    </div>
                    <div class="status-badge status-completed">
                        <i class="fas fa-check" aria-hidden="true"></i>
                        Complete
                    </div>
                </div>

                <div class="progress-item">
                    <div class="progress-info">
                        <div class="progress-icon {% if election.current_phase == 'delegate_voting' %}pending{% elif election.current_phase|slice:':15' != 'delegate_voting' and election.current_phase != 'registration' %}completed{% else %}inactive{% endif %}">
                            <i class="fas fa-users-cog" aria-hidden="true"></i>
                        </div>
                        <div>
                            <div class="progress-label">Delegate Voting</div>
                            <div class="progress-description">
                                {{ election.delegate_voting_start|date:"M d" }} - {{ election.delegate_voting_end|date:"M d" }}
                            </div>
                        </div>
                    </div>
                    <div class="status-badge {% if election.current_phase == 'delegate_voting' %}status-active{% elif election.current_phase|slice:':15' != 'delegate_voting' and election.current_phase != 'registration' %}status-completed{% else %}status-inactive{% endif %}">
                        {% if election.current_phase == 'delegate_voting' %}
                            <i class="fas fa-play" aria-hidden="true"></i>
                            Active
                        {% elif election.current_phase|slice:':15' != 'delegate_voting' and election.current_phase != 'registration' %}
                            <i class="fas fa-check" aria-hidden="true"></i>
                            Complete
                        {% else %}
                            <i class="fas fa-clock" aria-hidden="true"></i>
                            Upcoming
                        {% endif %}
                    </div>
                </div>

                <div class="progress-item">
                    <div class="progress-info">
                        <div class="progress-icon {% if election.current_phase == 'main_voting' %}pending{% elif election.current_phase == 'results' %}completed{% else %}inactive{% endif %}">
                            <i class="fas fa-vote-yea" aria-hidden="true"></i>
                        </div>
                        <div>
                            <div class="progress-label">Executive Voting</div>
                            <div class="progress-description">
                                {{ election.main_voting_start|date:"M d" }} - {{ election.main_voting_end|date:"M d" }}
                            </div>
                        </div>
                    </div>
                    <div class="status-badge {% if election.current_phase == 'main_voting' %}status-active{% elif election.current_phase == 'results' %}status-completed{% else %}status-inactive{% endif %}">
                        {% if election.current_phase == 'main_voting' %}
                            <i class="fas fa-play" aria-hidden="true"></i>
                            Active
                        {% elif election.current_phase == 'results' %}
                            <i class="fas fa-check" aria-hidden="true"></i>
                            Complete
                        {% else %}
                            <i class="fas fa-clock" aria-hidden="true"></i>
                            Upcoming
                        {% endif %}
                    </div>
                </div>

                <div class="progress-item">
                    <div class="progress-info">
                        <div class="progress-icon {% if election.current_phase == 'results' %}completed{% else %}inactive{% endif %}">
                            <i class="fas fa-trophy" aria-hidden="true"></i>
                        </div>
                        <div>
                            <div class="progress-label">Results</div>
                            <div class="progress-description">Election results published</div>
                        </div>
                    </div>
                    <div class="status-badge {% if election.current_phase == 'results' %}status-completed{% else %}status-inactive{% endif %}">
                        {% if election.current_phase == 'results' %}
                            <i class="fas fa-check" aria-hidden="true"></i>
                            Available
                        {% else %}
                            <i class="fas fa-clock" aria-hidden="true"></i>
                            Upcoming
                        {% endif %}
                    </div>
                </div>
            </div>
        </article>

        <!-- Help & Support Card -->
        <article class="professional-card">
            <header class="card-header-custom">
                <h3 class="section-title">
                    <div class="section-icon">
                        <i class="fas fa-question-circle" aria-hidden="true"></i>
                    </div>
                    Need Help?
                </h3>
            </header>
            <div class="card-body p-4">
                <div class="d-grid gap-2">
                    <a href="#" class="btn btn-outline-primary">
                        <i class="fas fa-book me-2" aria-hidden="true"></i>
                        Voting Guide
                    </a>
                    <a href="#" class="btn btn-outline-primary">
                        <i class="fas fa-question me-2" aria-hidden="true"></i>
                        FAQ
                    </a>
                    <a href="#" class="btn btn-outline-primary">
                        <i class="fas fa-headset me-2" aria-hidden="true"></i>
                        Contact Support
                    </a>
                </div>
                
                <div class="mt-3 pt-3 border-top">
                    <small class="text-muted">
                        <i class="fas fa-shield-alt me-1" aria-hidden="true"></i>
                        Your vote is confidential and secure. Need technical assistance? 
                        <a href="mailto:elections@muranga.ac.ke">Contact us</a>
                    </small>
                </div>
            </div>
        </article>
    </aside>
</div>

{% else %}
<!-- No Active Election State -->
<section class="text-center py-5" role="main">
    <div class="empty-state">
        <div class="empty-state-icon">
            <i class="fas fa-calendar-times" aria-hidden="true"></i>
        </div>
        <h2 class="empty-state-title">No Active Elections</h2>
        <p class="empty-state-description">
            There are currently no active elections. Check back later or contact the 
            student union office for more information about upcoming elections.
        </p>
        <div class="mt-4">
            <a href="{% url 'election_schedule' %}" class="btn btn-primary me-3">
                <i class="fas fa-calendar me-2" aria-hidden="true"></i>
                View Schedule
            </a>
            <a href="{% url 'past_elections' %}" class="btn btn-outline-primary">
                <i class="fas fa-history me-2" aria-hidden="true"></i>
                Past Elections
            </a>
        </div>
    </div>
</section>
{% endif %}

<!-- Professional JavaScript -->
<script>
'use strict';

class VotingDashboard {
    constructor() {
        this.csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setupAccessibility();
        this.setupAnimations();
    }

    setupEventListeners() {
        // Card selection handlers
        document.querySelectorAll('.voting-card').forEach(card => {
            card.addEventListener('click', (e) => this.handleCardClick(e));
            card.addEventListener('keydown', (e) => this.handleCardKeydown(e));
        });

        // Manifesto toggles
        document.querySelectorAll('.manifesto-toggle').forEach(toggle => {
            toggle.addEventListener('click', (e) => this.handleManifestoToggle(e));
        });
    }

    setupAccessibility() {
        // Announce important changes to screen readers
        this.announceToScreenReader = (message) => {
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.className = 'sr-only';
            announcement.textContent = message;
            document.body.appendChild(announcement);
            setTimeout(() => document.body.removeChild(announcement), 1000);
        };
    }

    setupAnimations() {
        // Intersection Observer for smooth animations
        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.professional-card').forEach(card => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                observer.observe(card);
            });
        }
    }

    handleCardClick(event) {
        if (event.target.closest('button') || event.target.closest('.manifesto-toggle')) {
            return;
        }

        const card = event.currentTarget;
        const section = card.closest('article, section');
        
        // Remove selection from other cards in the same section
        section.querySelectorAll('.voting-card').forEach(c => {
            c.classList.remove('selected');
            c.setAttribute('aria-selected', 'false');
        });
        
        // Select clicked card
        card.classList.add('selected');
        card.setAttribute('aria-selected', 'true');
        
        // Announce selection
        const candidateName = card.querySelector('.candidate-name')?.textContent ||
                            card.querySelector('.delegate-name')?.textContent;
        if (candidateName) {
            this.announceToScreenReader(`${candidateName} selected`);
        }
    }

    handleCardKeydown(event) {
        if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            this.handleCardClick(event);
        }
    }

    handleManifestoToggle(event) {
        event.preventDefault();
        const link = event.currentTarget;
        const candidateId = link.onclick.toString().match(/\d+/)[0];
        const manifesto = document.getElementById(`manifesto-${candidateId}`);
        const isExpanded = link.getAttribute('aria-expanded') === 'true';

        if (!isExpanded) {
            manifesto.style.display = 'block';
            link.setAttribute('aria-expanded', 'true');
            link.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hide Manifesto';
        } else {
            manifesto.style.display = 'none';
            link.setAttribute('aria-expanded', 'false');
            link.innerHTML = '<i class="fas fa-file-alt me-1"></i>View Manifesto';
        }
    }

    showLoading(button) {
        button.classList.add('loading');
        button.disabled = true;
        button.setAttribute('aria-busy', 'true');
    }

    hideLoading(button) {
        button.classList.remove('loading');
        button.disabled = false;
        button.removeAttribute('aria-busy');
    }

    showToast(message, type = 'info') {
        // Create toast notification
        const toast = document.createElement('div');
        toast.className = `alert alert-${type}-enhanced position-fixed top-0 end-0 m-3`;
        toast.style.zIndex = '1050';
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        
        const icon = type === 'success' ? 'check-circle' : 
                    type === 'danger' ? 'exclamation-triangle' : 'info-circle';
        
        toast.innerHTML = `
            <i class="fas fa-${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close ms-3" onclick="this.parentElement.remove()"></button>
        `;
        
        document.body.appendChild(toast);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }

    async voteForDelegate(delegateId) {
        const button = event.target.closest('button');
        this.showLoading(button);

        try {
            const response = await fetch('{% url "vote_delegate" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.csrfToken
                },
                body: JSON.stringify({ delegate_id: delegateId })
            });

            const data = await response.json();
            
            if (data.success) {
                this.showToast(data.message, 'success');
                this.announceToScreenReader('Vote successfully recorded');
                
                // Update UI to show voted state
                const card = button.closest('.voting-card');
                card.classList.add('voted');
                button.innerHTML = '<i class="fas fa-check me-2"></i>Vote Recorded';
                button.classList.replace('btn-vote', 'btn-voted');
                
                // Disable all other delegate cards
                document.querySelectorAll('.voting-card[data-delegate-id]').forEach(c => {
                    const btn = c.querySelector('.vote-button');
                    if (btn && c !== card) {
                        btn.disabled = true;
                        btn.classList.add('opacity-50');
                    }
                });
                
                setTimeout(() => location.reload(), 2000);
            } else {
                this.showToast(data.error || 'An error occurred while voting', 'danger');
                this.hideLoading(button);
            }
        } catch (error) {
            console.error('Voting error:', error);
            this.showToast('Network error. Please check your connection and try again.', 'danger');
            this.hideLoading(button);
        }
    }

    async voteForCandidate(candidateId, positionName) {
        const button = event.target.closest('button');
        this.showLoading(button);

        try {
            const response = await fetch('{% url "vote_candidate" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.csrfToken
                },
                body: JSON.stringify({ candidate_id: candidateId })
            });

            const data = await response.json();
            
            if (data.success) {
                this.showToast(data.message, 'success');
                this.announceToScreenReader(`Vote recorded for ${positionName}`);
                
                // Update the entire position section
                const positionSection = button.closest('section');
                const allButtons = positionSection.querySelectorAll('.vote-button');
                
                allButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-check me-2"></i>Vote Recorded';
                    btn.classList.replace('btn-vote', 'btn-voted');
                });
                
                // Update status badge
                const statusBadge = positionSection.querySelector('.status-badge');
                statusBadge.className = 'status-badge status-completed';
                statusBadge.innerHTML = '<i class="fas fa-check"></i> Voted';
                
            } else {
                this.showToast(data.error || 'An error occurred while voting', 'danger');
                this.hideLoading(button);
            }
        } catch (error) {
            console.error('Voting error:', error);
            this.showToast('Network error. Please check your connection and try again.', 'danger');
            this.hideLoading(button);
        }
    }
}

// Global functions for backward compatibility
function voteForDelegate(delegateId) {
    window.votingDashboard.voteForDelegate(delegateId);
}

function voteForCandidate(candidateId, positionName) {
    window.votingDashboard.voteForCandidate(candidateId, positionName);
}

function toggleManifesto(candidateId) {
    const link = event.target;
    window.votingDashboard.handleManifestoToggle({ 
        currentTarget: link, 
        preventDefault: () => {} 
    });
}

// Initialize dashboard when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    window.votingDashboard = new VotingDashboard();
    
    // Add smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth' });
                target.focus();
            }
        });
    });
});

// Handle page visibility changes
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && window.votingDashboard) {
        // Optionally refresh data when user returns to tab
        console.log('Page became visible - consider refreshing election status');
    }
});
</script>
{% endblock %}